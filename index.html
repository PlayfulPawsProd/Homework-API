<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mika's Homework Helper! ♡</title>
    <!-- Link the Manifest File -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme Color for Browser UI -->
    <meta name="theme-color" content="#d81b60">
    <style>
        /* --- Base Styles --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes subtlePulse { 0%, 100% { box-shadow: 0 0 8px rgba(240, 98, 146, 0.5); } 50% { box-shadow: 0 0 12px rgba(240, 98, 146, 0.8); } }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffe0f0;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* --- Pop-up Modal Styles (Shared) --- */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none; /* Hidden by default, shown via JS */
            justify-content: center; align-items: center;
            z-index: 200; backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }
        .popup-modal {
            background: #ffe0f0; padding: 30px 40px; border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            text-align: center; border: 4px solid #d81b60;
            max-width: 450px; width: 90%;
            animation: fadeIn 0.4s ease-out 0.1s backwards;
        }
        .popup-modal h2 { color: #a32d37; margin-top: 0; margin-bottom: 15px; font-size: 1.6em; }
        .popup-modal p { color: #555; margin-bottom: 20px; line-height: 1.5; font-size: 0.95em; }
        .popup-modal input[type="text"], .popup-modal input[type="password"] {
            width: 100%; padding: 12px 15px; margin-bottom: 15px;
            border: 2px solid #f06292; border-radius: 8px; font-size: 1em;
            box-sizing: border-box; background-color: #fff3f7; color: #333;
        }
        .popup-modal input:focus {
            outline: none; border-color: #d81b60;
            box-shadow: 0 0 8px rgba(216, 27, 96, 0.5);
            animation: subtlePulse 1.5s infinite;
        }
        .popup-buttons { display: flex; justify-content: space-around; margin-top: 10px; gap: 15px; }
        .popup-button {
            padding: 10px 25px; font-size: 1em; font-weight: bold; border-radius: 20px;
            cursor: pointer; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease; border: none;
            color: white; background: linear-gradient(45deg, #d81b60, #f06292);
        }
         .popup-button.secondary { /* For "Later" or "No Thanks" */
             background: #eee;
             color: #555;
             border: 1px solid #ccc;
         }
        .popup-button:hover { transform: scale(1.05); box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3); }
        .popup-button.secondary:hover { background: #ddd; }
        .popup-button:active { transform: scale(0.98); }
        .popup-error { color: #c62828; font-weight: bold; margin-top: 15px; display: none; font-size: 0.9em; }

        /* --- Main Chat Container --- */
        #chat-container {
            width: 100%; max-width: 800px; height: 90vh; max-height: 700px;
            background-color: #1a0d13; color: #ffacd1;
            border: 3px solid #f06292; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none; /* Hidden until key and name are set */
            flex-direction: column; justify-content: space-between; align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 15px; line-height: 1.5; overflow: hidden; padding: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* --- Header Area --- */
        #chat-header {
            width: 100%; background-color: rgba(240, 98, 146, 0.2); padding: 10px 15px;
            box-sizing: border-box; text-align: center; border-bottom: 1px solid #f06292;
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
            position: relative;
        }
        #chat-header h2 { margin: 0; font-size: 1.3em; color: #fce4ec; text-shadow: 0 0 3px #f06292; cursor: default; }
        .header-buttons { display: flex; align-items: center; }
        .header-button {
             padding: 5px 10px; font-size: 0.8em; background-color: #f06292; color: #1a0d13;
             border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s, transform 0.1s;
             margin-left: 8px;
        }
        .header-button:hover { background-color: #d81b60; transform: scale(1.05); }
        .header-button:active { transform: scale(0.98); }

        /* --- Chat History Dropdown --- */
        #history-dropdown {
            display: none; position: absolute; top: 100%; right: 15px; background-color: #1a0d13;
            border: 1px solid #f06292; border-radius: 5px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            z-index: 10; max-height: 200px; overflow-y: auto; min-width: 180px;
             scrollbar-width: thin; scrollbar-color: #f06292 #1a1a2e;
        }
        #history-dropdown button {
            display: block; width: 100%; padding: 8px 12px; background: none; border: none;
            border-bottom: 1px solid rgba(240, 98, 146, 0.3); color: #ffacd1; text-align: left;
            cursor: pointer; font-size: 0.9em;
        }
        #history-dropdown button:last-child { border-bottom: none; }
        #history-dropdown button:hover { background-color: rgba(240, 98, 146, 0.2); }
         #history-dropdown button.delete-history { color: #ff8a80; font-weight: bold; border-top: 1px solid #f06292; margin-top: 5px; }
         #history-dropdown button.delete-history:hover { background-color: rgba(255, 138, 128, 0.3); }

        /* --- Chat Log --- */
        #chat-log {
            width: 100%; height: 100%; background-color: rgba(20, 0, 10, 0.7);
            overflow-y: auto; padding: 15px; box-sizing: border-box;
            scrollbar-width: thin; scrollbar-color: #f06292 #1a1a2e; color: #ffe0f0;
            text-align: left; flex-grow: 1;
        }
        #chat-log p { margin: 5px 0 10px 0; line-height: 1.5; word-wrap: break-word; max-width: 100%; }
        #chat-log .user-message { color: #ade8f4; text-align: right; margin-left: auto; max-width: 85%; }
        #chat-log .user-message strong { color: #48cae4; } /* Name will go here */
        #chat-log .mika-message { color: #ffacd1; margin-right: auto; max-width: 85%; }
        #chat-log .mika-message strong { color: #f06292; }
        #chat-log .system-message { color: #aaa; font-style: italic; font-size: 0.9em; text-align: center; }
        #chat-log .typing-indicator { color: #f06292; font-style: italic; font-size: 0.9em; text-align: center; animation: fadeIn 0.3s; }

        /* --- Chat Input Area --- */
        #chat-input-area {
            display: flex; width: 100%; padding: 10px 15px; box-sizing: border-box;
            border-top: 1px solid #f06292; background-color: rgba(240, 98, 146, 0.1);
            flex-shrink: 0;
        }
        #chat-input {
            flex-grow: 1; padding: 10px 15px; border: 1px solid #f06292; background-color: #1a1a2e;
            color: #ffe0f0; border-radius: 20px 0 0 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1em; outline: none; transition: box-shadow 0.2s;
        }
        #chat-input:focus { box-shadow: 0 0 8px rgba(240, 98, 146, 0.6); }
        #chat-input:disabled { background-color: #444; cursor: not-allowed; }
        #send-button {
            padding: 10px 20px; border: 1px solid #f06292; background: linear-gradient(45deg, #d81b60, #f06292);
            color: white; font-weight: bold; cursor: pointer; border-radius: 0 20px 20px 0;
            transition: background 0.2s ease, transform 0.1s;
        }
        #send-button:hover { background: linear-gradient(45deg, #f06292, #d81b60); transform: scale(1.02); }
        #send-button:active { transform: scale(0.98); }
        #send-button:disabled { background: #666; cursor: not-allowed; transform: none; }

        /* --- Scrollbar Styles --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(26, 13, 19, 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #f06292; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #d81b60; }

        /* --- Responsive Styles --- */
         @media (max-width: 600px) {
             body { padding: 5px; }
             .popup-modal { padding: 20px 25px; }
             .popup-modal h2 { font-size: 1.4em; }
             .popup-modal p { font-size: 0.9em;}
             .popup-button { padding: 8px 20px; font-size: 0.9em; }
             #chat-container { height: 95vh; border-radius: 10px; font-size: 14px; }
             #chat-header h2 { font-size: 1.1em; }
             .header-button { font-size: 0.75em; padding: 4px 8px; }
             #chat-log { padding: 10px; }
             #chat-input-area { padding: 8px 10px; }
             #chat-input { padding: 8px 12px; font-size: 0.95em; }
             #send-button { padding: 8px 15px; font-size: 0.95em; }
             #history-dropdown { max-height: 150px; }
         }

    </style>
</head>
<body>

    <!-- API Key Popup (First) -->
    <div id="api-key-popup" class="popup-overlay">
        <div class="popup-modal">
            <h2>(=^･ω･^=) Mika needs the Secret Code!</h2>
            <p>To start chatting, please enter your Google Gemini API Key! It gets saved safely in *your* browser so you don't have to enter it every time, nya~!</p>
            <input type="password" id="api-key-input" placeholder="Paste your Gemini API Key here~ ♡">
            <p id="api-key-error" class="popup-error">Meeeow! You need to paste a key in here!</p>
            <div class="popup-buttons">
                <button id="save-api-key-button" class="popup-button">Save & Continue! ♡</button>
            </div>
        </div>
    </div>

    <!-- Name Input Popup (Second) -->
    <div id="name-popup" class="popup-overlay">
         <div class="popup-modal">
             <h2>☆ Who am I helping today? ☆</h2>
             <p>Tell me your name so I know who my awesome Study Buddy is! (Or just leave it as Master if you like~ ♡)</p>
             <input type="text" id="name-input" placeholder="Enter name here~">
             <p id="name-error" class="popup-error">Please enter a name!</p>
             <div class="popup-buttons">
                 <button id="save-name-button" class="popup-button">That's Me!</button>
             </div>
         </div>
     </div>

     <!-- PWA Install Popup (Optional, Third) -->
     <div id="install-popup" class="popup-overlay">
          <div class="popup-modal">
              <h2>☆ Install Mika Helper? ☆</h2>
              <p>Want to add me to your Home Screen like a real app for easy access? Nyaa~!</p>
              <div class="popup-buttons">
                  <button id="install-button" class="popup-button">Install Me! ♡</button>
                  <button id="install-later-button" class="popup-button secondary">Maybe Later</button>
              </div>
          </div>
      </div>


    <!-- Main Chat Interface (Hidden until setup complete) -->
    <div id="chat-container">
         <div id="chat-header">
             <h2 id="chat-title">Study Time with Mika! ♡</h2> <!-- Title will be updated -->
             <div class="header-buttons">
                 <button id="history-button" class="header-button" title="View Past Chats">History</button>
                 <button id="new-chat-button" class="header-button" title="Start a New Chat">New Chat</button>
                 <button id="settings-button" class="header-button" title="Change API Key or Name">⚙️ Settings</button>
             </div>
              <!-- Chat History Dropdown -->
              <div id="history-dropdown">
                   <!-- History items will be added here -->
                   <button class="delete-history" id="delete-all-history-button">Delete ALL History</button>
              </div>
         </div>
        <div id="chat-log">
             <!-- Messages appear here -->
             <p class="system-message">Initializing...</p>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Loading..." disabled>
            <button id="send-button" disabled>Send</button>
        </div>
    </div>

    <!-- Include the API script -->
    <script src="api.js"></script>

    <script>
        // Nyaa~! Homework Helper Mika with localStorage, PWA Install & Name!

        // --- DOM Elements ---
        const apiKeyPopup = document.getElementById('api-key-popup');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const apiKeyError = document.getElementById('api-key-error');

        const namePopup = document.getElementById('name-popup');
        const nameInput = document.getElementById('name-input');
        const saveNameButton = document.getElementById('save-name-button');
        const nameError = document.getElementById('name-error');

        const installPopup = document.getElementById('install-popup');
        const installButton = document.getElementById('install-button');
        const installLaterButton = document.getElementById('install-later-button');

        const chatContainer = document.getElementById('chat-container');
        const chatLog = document.getElementById('chat-log');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const settingsButton = document.getElementById('settings-button');
        const newChatButton = document.getElementById('new-chat-button');
        const historyButton = document.getElementById('history-button');
        const historyDropdown = document.getElementById('history-dropdown');
        const deleteAllHistoryButton = document.getElementById('delete-all-history-button'); // Keep ref if needed elsewhere
        const chatTitle = document.getElementById('chat-title');


        // --- Chat State & Config ---
        let currentChatHistory = [];
        let isMikaTyping = false;
        let currentApiKey = null;
        let currentUserName = "Master"; // Default name
        let allChats = {};
        let currentChatId = null;
        const MAX_HISTORY_LENGTH = 16; // Keep last 8 pairs
        let deferredInstallPrompt = null;

        // --- Utility Functions ---
        const getTimestamp = () => Date.now();
        const sanitizeHTML = (str) => {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };

        // --- Local Storage Functions ---
        function saveToLocalStorage(key, value) {
            try {
                localStorage.setItem(key, value);
                console.log(`Saved ${key} to localStorage.`);
                return true;
            } catch (e) {
                console.error(`Failed to save ${key} to localStorage:`, e);
                // Avoid showing alerts for storage errors unless critical
                // appendMessage('system', `Mrow! Couldn't save ${key}... maybe your browser storage is full or disabled? ;_;`);
                return false;
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const value = localStorage.getItem(key);
                if (value) {
                    console.log(`Loaded ${key} from localStorage.`);
                    return value;
                }
            } catch (e) {
                console.error(`Failed to load ${key} from localStorage:`, e);
            }
            console.log(`No ${key} found in localStorage.`);
            return null;
        }

        function clearFromLocalStorage(key) {
             try {
                localStorage.removeItem(key);
                console.log(`Cleared ${key} from localStorage.`);
            } catch (e) {
                console.error(`Failed to clear ${key} from localStorage:`, e);
            }
        }

        const saveApiKey = (key) => saveToLocalStorage('geminiApiKey_mikaHelper', key);
        const loadApiKey = () => loadFromLocalStorage('geminiApiKey_mikaHelper');
        const clearApiKey = () => clearFromLocalStorage('geminiApiKey_mikaHelper');

        const saveUserName = (name) => saveToLocalStorage('mikaHelper_userName', name);
        const loadUserName = () => loadFromLocalStorage('mikaHelper_userName');
        const clearUserName = () => clearFromLocalStorage('mikaHelper_userName');

        function saveAllChats() {
            try {
                if (currentChatId && currentChatHistory.length > 0) {
                     allChats[currentChatId] = currentChatHistory;
                }
                // Only save if there's something to save
                if (Object.keys(allChats).length > 0) {
                    saveToLocalStorage('mikaHelper_allChats', JSON.stringify(allChats));
                } else {
                    // If allChats is empty, clear it from storage too
                    clearFromLocalStorage('mikaHelper_allChats');
                }
            } catch (e) { /* Error handled in saveToLocalStorage */ }
        }

        function loadAllChats() {
             try {
                const storedChats = loadFromLocalStorage('mikaHelper_allChats');
                if (storedChats) {
                    allChats = JSON.parse(storedChats);
                    const chatIds = Object.keys(allChats).sort((a, b) => b - a);
                    if (chatIds.length > 0) return chatIds[0];
                }
            } catch (e) {
                console.error("Failed to parse chats from localStorage:", e);
                allChats = {};
                clearFromLocalStorage('mikaHelper_allChats');
            }
            return null;
        }

         function deleteAllChats() {
             // Use currentUserName in the confirmation dialog
             if (confirm(`Hey ${currentUserName}! Are you SURE you want to delete ALL our chat history forever?! (ฅΦωΦฅ);;`)) {
                 clearFromLocalStorage('mikaHelper_allChats');
                 allChats = {};
                 startNewChat(false); // Start fresh without greeting
                 updateHistoryDropdown();
                 appendMessage('system', "All chat history deleted. It's like we just met again, nyaa~!");
                 console.log("All chat history deleted.");
             }
             // Hide dropdown after action regardless of choice
             if (historyDropdown.style.display === 'block') historyDropdown.style.display = 'none';
         }

        // --- PWA Install Functions ---
        function setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (event) => {
                event.preventDefault();
                deferredInstallPrompt = event;
                console.log('`beforeinstallprompt` event fired and stored.');
                const installPromptShown = loadFromLocalStorage('mikaInstallPromptShown');
                // Only show the custom prompt if the event exists AND we haven't shown it before (or user cleared storage)
                if (!installPromptShown) {
                    installPopup.style.display = 'flex';
                } else {
                    console.log('Install prompt already shown/dismissed this session.');
                }
            });

             installButton.addEventListener('click', async () => {
                 installPopup.style.display = 'none';
                 if (deferredInstallPrompt) {
                     deferredInstallPrompt.prompt();
                     const { outcome } = await deferredInstallPrompt.userChoice;
                     console.log(`User response to the install prompt: ${outcome}`);
                     deferredInstallPrompt = null;
                     saveToLocalStorage('mikaInstallPromptShown', 'true'); // Mark as shown/actioned
                 }
             });

             installLaterButton.addEventListener('click', () => {
                 installPopup.style.display = 'none';
                 saveToLocalStorage('mikaInstallPromptShown', 'true'); // Mark as shown/actioned
                 console.log('User chose to install later.');
             });

             window.addEventListener('appinstalled', () => {
               console.log('Mika PWA was installed!');
               installPopup.style.display = 'none';
               deferredInstallPrompt = null;
               // Maybe remove the install prompt shown flag so it *could* appear again if uninstalled? Optional.
               // clearFromLocalStorage('mikaInstallPromptShown');
             });
        }

         function registerServiceWorker() {
             if ('serviceWorker' in navigator) {
                 navigator.serviceWorker.register('sw.js')
                 .then((registration) => console.log('Mika Service Worker registered with scope:', registration.scope))
                 .catch((error) => console.error('Mika Service Worker registration failed:', error));
             } else {
                 console.log("Service Workers not supported.");
             }
         }


        // --- Chat Interface Functions ---

        function appendMessage(sender, message, isHtml = false) {
             if (!chatLog || chatContainer.style.display === 'none') {
                 console.warn("Attempted to append message while chat log is hidden or missing.");
                 return;
             }

            const messageElement = document.createElement('p');
            const sanitizedMessage = isHtml ? message : sanitizeHTML(message);

            if (sender === 'user') {
                messageElement.className = 'user-message';
                messageElement.innerHTML = `<strong>${sanitizeHTML(currentUserName)}:</strong> ${sanitizedMessage}`;
            } else if (sender === 'Mika') {
                messageElement.className = 'mika-message';
                let processedMessage = sanitizedMessage
                     .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                     .replace(/\*(.*?)\*/g, '<em>$1</em>')
                     .replace(/`([^`]+)`/g, '<code>$1</code>')
                     .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre><code>${sanitizeHTML(p1.trim())}</code></pre>`)
                     .replace(/(?<!<br>)\n/g, '<br>');
                messageElement.innerHTML = `<strong>Mika:</strong> ${processedMessage}`;
            } else {
                 messageElement.className = 'system-message';
                 messageElement.innerHTML = sanitizedMessage;
            }
            chatLog.appendChild(messageElement);
            scrollToBottom();
        }

         function showTypingIndicator() {
             removeTypingIndicator();
             const typingElement = document.createElement('p');
             typingElement.className = 'typing-indicator';
             typingElement.innerHTML = 'Mika is thinking... *purrrr*';
             chatLog.appendChild(typingElement);
             scrollToBottom();
         }

         function removeTypingIndicator() {
             const typingIndicator = chatLog.querySelector('.typing-indicator');
             if (typingIndicator) typingIndicator.remove();
         }

        function scrollToBottom() {
            setTimeout(() => { chatLog.scrollTop = chatLog.scrollHeight; }, 50);
        }

        function clearChatDisplay() { chatLog.innerHTML = ''; }

         function enableChatInput() {
             chatInput.disabled = false;
             sendButton.disabled = false;
             // Use the updated name here
             chatInput.placeholder = `Ask Mika about your homework, ${currentUserName || 'Study Buddy'}~ ♡`;
         }

         function disableChatInput(message = "Mika is thinking...") {
             chatInput.disabled = true;
             sendButton.disabled = true;
             chatInput.placeholder = message;
         }

        function updateChatTitle() {
            chatTitle.textContent = `Study Time with ${sanitizeHTML(currentUserName)}! ♡`;
        }

         // Updates the placeholder text in the input field
         function updateInputPlaceholder() {
            if (chatInput) {
                 chatInput.placeholder = `Ask Mika about your homework, ${currentUserName || 'Study Buddy'}~ ♡`;
            }
        }

        // --- Chat Management Functions ---

        function startNewChat(greet = true) {
             if (currentChatId && currentChatHistory.length > 0) {
                  allChats[currentChatId] = currentChatHistory;
                  saveAllChats();
             }
             currentChatId = getTimestamp();
             currentChatHistory = [];
             clearChatDisplay();
             if (greet) {
                appendMessage('system', `Started a new chat! What can I help you with, ${currentUserName}? Nyaa~!`);
             } else {
                 appendMessage('system', `Started a new chat.`);
             }
             enableChatInput(); // Will use currentUserName in placeholder
             updateHistoryDropdown();
             console.log(`Started new chat with ID: ${currentChatId}`);
             if (historyDropdown.style.display === 'block') historyDropdown.style.display = 'none';
        }

        function loadChat(chatId) {
             if (currentChatId && currentChatHistory.length > 0 && currentChatId !== chatId) {
                  allChats[currentChatId] = currentChatHistory;
             }

             if (allChats[chatId]) {
                 currentChatId = chatId;
                 currentChatHistory = allChats[chatId];
                 clearChatDisplay();
                 appendMessage('system', `Loaded chat from ${new Date(parseInt(chatId)).toLocaleString()}. Welcome back, ${currentUserName}!`);
                 currentChatHistory.forEach(msg => {
                     if (msg.role === 'user') {
                         appendMessage('user', msg.parts[0].text);
                     } else if (msg.role === 'model') {
                         appendMessage('Mika', msg.parts[0].text);
                     }
                 });
                 enableChatInput(); // Will use currentUserName in placeholder
                 console.log(`Loaded chat ID: ${chatId}`);
             } else {
                 console.error(`Chat ID ${chatId} not found.`);
                 appendMessage('system', "Mrow! Couldn't find that chat history!");
             }
             if (historyDropdown.style.display === 'block') historyDropdown.style.display = 'none';
             saveAllChats();
        }

         function updateHistoryDropdown() {
             if (!historyDropdown) return;
             historyDropdown.innerHTML = '';

             const chatIds = Object.keys(allChats).sort((a, b) => b - a);

             if (chatIds.length === 0 && (!currentChatId || currentChatHistory.length === 0)) {
                historyDropdown.innerHTML = '<p style="padding: 8px; color: #aaa; text-align: center; font-size: 0.9em;">No past chats yet!</p>';
             } else {
                 if (currentChatId && currentChatHistory.length > 0 && !allChats[currentChatId]) {
                    const currentBtn = document.createElement('button');
                    currentBtn.textContent = `Current Chat (Unsaved) - ${new Date(parseInt(currentChatId)).toLocaleTimeString()}`;
                    currentBtn.disabled = true;
                    currentBtn.style.opacity = 0.7;
                    historyDropdown.appendChild(currentBtn);
                 }

                chatIds.forEach(id => {
                    const chat = allChats[id];
                    if (chat && chat.length > 0) {
                        const button = document.createElement('button');
                         const firstUserMsg = chat.find(m => m.role === 'user');
                         const preview = firstUserMsg ? sanitizeHTML(firstUserMsg.parts[0].text.substring(0, 20)) + '...' : 'Chat';
                         button.textContent = `${new Date(parseInt(id)).toLocaleString()} - ${preview}`;
                         button.title = `Load chat from ${new Date(parseInt(id)).toLocaleString()}`;
                         button.onclick = () => loadChat(id);
                         historyDropdown.appendChild(button);
                    }
                });
             }

             const deleteAllBtn = document.createElement('button');
             deleteAllBtn.textContent = 'Delete ALL History';
             deleteAllBtn.className = 'delete-history';
             deleteAllBtn.title = 'Permanently delete all saved chats!';
             deleteAllBtn.onclick = deleteAllChats;
             historyDropdown.appendChild(deleteAllBtn);
        }


        // --- API Call & Message Handling ---
        async function handleSendMessage() {
            const messageText = chatInput.value.trim();
            // Ensure currentUserName has a value, default to 'Study Buddy' if somehow null/empty
            const userNameForApi = currentUserName || "Study Buddy";

            if (!messageText || isMikaTyping || !currentApiKey) return;

            appendMessage('user', messageText); // Uses currentUserName for display via its own logic
            currentChatHistory.push({ role: 'user', parts: [{ text: messageText }] });
            chatInput.value = '';
            isMikaTyping = true;
            disableChatInput();
            showTypingIndicator();

             if (currentChatHistory.length > MAX_HISTORY_LENGTH) {
                 currentChatHistory = currentChatHistory.slice(-MAX_HISTORY_LENGTH);
                 console.log("Chat history pruned.");
             }

            try {
                // Pass the current user's name to the API function
                const mikaResponse = await sendMessageToMika(messageText, currentChatHistory, currentApiKey, userNameForApi);

                removeTypingIndicator();
                appendMessage('Mika', mikaResponse);
                currentChatHistory.push({ role: 'model', parts: [{ text: mikaResponse }] });
                saveAllChats();

            } catch (error) {
                console.error("Error in handleSendMessage:", error);
                removeTypingIndicator();
                // Use the current user's name in the error message
                appendMessage('system', error.message || `Mrow! Something went wrong, ${userNameForApi}... Mika can't talk right now. ;_;`);
            } finally {
                isMikaTyping = false;
                if (currentApiKey) {
                    enableChatInput(); // Will use currentUserName in placeholder
                    chatInput.focus();
                 } else {
                     disableChatInput("API Key needed!");
                 }
            }
        }


        // --- Initialization Flow ---
        function proceedToChat() {
            chatContainer.style.display = 'flex';
            const mostRecentChatId = loadAllChats();
            clearChatDisplay();
            updateInputPlaceholder(); // Set placeholder correctly before loading/starting
            if (mostRecentChatId) {
                loadChat(mostRecentChatId);
            } else {
                startNewChat(true); // Start fresh with greeting
            }
            // enableChatInput(); // Already called within loadChat/startNewChat
            updateChatTitle();
            updateHistoryDropdown();
            setupInstallPrompt(); // Check for PWA install prompt now UI is ready
        }

        function checkNameAndProceed() {
            const storedName = loadUserName();
            if (storedName) {
                currentUserName = storedName;
                namePopup.style.display = 'none';
                updateInputPlaceholder(); // Update placeholder now name is loaded
                proceedToChat();
            } else {
                // Show name popup
                nameInput.value = "Master"; // Prefill default
                namePopup.style.display = 'flex';
                nameInput.focus();
                nameInput.select();
            }
        }

        function initializeApp() {
            registerServiceWorker(); // Register SW early

            const loadedKey = loadApiKey();
            if (loadedKey) {
                currentApiKey = loadedKey;
                apiKeyPopup.style.display = 'none';
                checkNameAndProceed(); // Key exists, check name next
            } else {
                // Show API key popup first
                apiKeyPopup.style.display = 'flex';
                chatContainer.style.display = 'none';
                disableChatInput("API Key needed!");
                apiKeyInput.focus();
            }
        }

        // --- Event Listeners ---
        saveApiKeyButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                if (saveApiKey(key)) {
                    currentApiKey = key;
                    apiKeyPopup.style.display = 'none';
                    apiKeyError.style.display = 'none';
                    checkNameAndProceed(); // Key saved, check name next
                }
            } else {
                apiKeyError.style.display = 'block';
            }
        });

         saveNameButton.addEventListener('click', () => {
             const name = nameInput.value.trim();
             if (name) {
                 if (saveUserName(name)) {
                     currentUserName = name; // Update state
                     namePopup.style.display = 'none';
                     nameError.style.display = 'none';
                     updateInputPlaceholder(); // Update placeholder immediately
                     proceedToChat(); // Name saved, proceed to chat
                 }
             } else {
                 nameError.style.display = 'block';
             }
         });

        apiKeyInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') saveApiKeyButton.click();
            if (apiKeyError.style.display === 'block') apiKeyError.style.display = 'none';
        });

         nameInput.addEventListener('keypress', (event) => {
             if (event.key === 'Enter') saveNameButton.click();
             if (nameError.style.display === 'block') nameError.style.display = 'none';
         });

        sendButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSendMessage();
            }
        });

        settingsButton.addEventListener('click', () => {
             if (confirm(`Change API Key or Name for ${currentUserName}? This will clear current settings and reload the page.`)) {
                 clearApiKey();
                 clearUserName();
                 // Clear install prompt shown flag so it might reappear
                 clearFromLocalStorage('mikaInstallPromptShown');
                 window.location.reload();
             }
        });

        newChatButton.addEventListener('click', () => startNewChat(true));

         historyButton.addEventListener('click', (event) => {
             event.stopPropagation();
             if (historyDropdown.style.display === 'block') {
                 historyDropdown.style.display = 'none';
             } else {
                 updateHistoryDropdown();
                 historyDropdown.style.display = 'block';
             }
         });

         document.addEventListener('click', (event) => {
             // Close dropdown if clicking anywhere outside the dropdown itself AND outside the history button
             if (historyDropdown.style.display === 'block' && !historyDropdown.contains(event.target) && event.target !== historyButton) {
                 historyDropdown.style.display = 'none';
             }
         });

        // --- Start the App ---
        initializeApp();

        // Auto-save chats when the window is closed/reloaded
         window.addEventListener('beforeunload', saveAllChats);

        // Nyaa~! Ready for homework fun with my Study Buddy! ♡

    </script>

</body>
</html>